<!DOCTYPE html>
<html>
  <head>
    <title>KVC Collection Operators</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <script src="https://github.com/downloads/gnab/remark/remark-0.4.2.min.js" type="text/javascript">
	{ 
		"highlightLanguage": "objectivec",
		"highlightInline": true,
		"highlightStyle": "solarized_light"
	}
	</script>
	<style type="text/css" media="screen">
	@import url(http://fonts.googleapis.com/css?family=Quattrocento+Sans:400,700);
	@import url(http://fonts.googleapis.com/css?family=Amaranth:700italic);

	h1 {
		font-family: 'Amaranth', sans-serif;
		font-weight: bold;
		font-style: italic;
	}
	body {
		font-family: 'Quattrocento Sans', sans-serif;
	}
	a {
		color: #a86;
		text-decoration: none;
	}
	code {
		word-wrap: break-word;
	}
	.position {
		visibility: hidden;
	}
	.footnote {
		position: absolute;
		bottom: 1em;
		left: 1em;
		right: 1em;
	}
	</style>
  </head>
  <body>
    <textarea id="source">

class: center, middle

# KVC Collection Operators
#### `@distinctUnionOfHacks`

.footnote[[n-b.github.com/custom-kvc-operators](http://github.com/n-b/custom-kvc-operators)]

	

---
layout: true
# Key-Value Coding Basics

---

`valueForKey:@"key"` appelle la méthode "key", si elle existe.
<!-- Elle essaye ensuite d'autres méthodes, avec underscode, etc, puis un accès direct aux ivars. -->

	[[@"hello"] uppercaseString]
	[@"hello" valueForKey:@"uppercaseString"]
		// -> @"HELLO"

---
Les Collections retournent une collection en appelant `valueForKey:` sur chaque objet.

	[@[@"hello",@"goodbye"] valueForKey:@"uppercaseString"]
		// -> @[@"HELLO",@"GOODBYE"]

---
`-[NSObject self]` est une méthode comme les autres.

	[@"hello" valueForKey:@"self"] 
		// -> @"hello"

---
layout: true
# KVC Paths

---

Les composants sont séparés par ".", et évalués de gauche à droite.
	
	[object valueForKeyPath:@"a.b.c"]

--
revient au même que :

	[[[object valueForKey:@"a"] valueForKey:@"b"] valueForKey:@"c"]

<!--Works with collections : if valueForKey:@"a" returns a collection, valueForKey:@"b" is called on each object of that collection, no problem. -->


---
layout:true
# Collections “Operators”

---

Un composant qui démarre par "@" permet d'utiliser une propriété de l'*objet* collection.

--

**Non documenté !**

--

<!-- The `@count` "operator" is just the `-[NSArray count]` method. -->

	[@[@"a",@"b"] count]
		// -> 2
	[@[@"a",@"b"] valueForKey:@"@count"]
		// -> @(2)

	[@[@"a",@"b"] valueForKey:@"@lastObject"]
		// -> @"b"

---

<!-- Let's try another method : -->

	@implementation NSArray (Reverse)
	- (instancetype) reverse
	{
	    return [[self reverseObjectEnumerator] allObjects];
	}
	@end

&nbsp;

	[array valueForKey:@"@reverse"]
		// -> @[@"b",@"a"]

<!-- custom operator ! -->
<!-- moreover, returns a collection, not an object -->

---
layout:true
# “Simple” Collections Operators

---

L'exemple de la documentation :

	[object valueForKeyPath:
	    @"keypathToCollection.@collectionOperator.keypathToProperty"]

--
revient au même que :

	[[object valueForKeyPath:@"keyPathToCollection"] 
	 valueForKeyPath:@"@collectionOperator.keypathToProperty"]

--
Etape par étape :

	[[[object valueForKeyPath:@"keyPathToCollection"] 
	  valueForKeyPath:@"keypathToProperty"]
	 performTheCollectionOperator]

---

Opérateurs “simples” : **@avg, @sum, @min, @max**

<!-- Take a parameter (a key path) on which to operate. -->
	
	[company valueForKeyPath:@"employees.@avg.salary"]
	
	[[company valueForKeyPath:@"employees.salary"] average]
		 // (just implement -[NSArray average])

--


Une implémentation de @avg : 

1. appelle `[self valueForKeyPath:@"<end_of_keypath>"]` <br>Le résultat ***doit*** être une collection de NSNumbers.
--

2. calcule la moyenne et la retourne sous forme de NSNumber.

<!-- Les keypaths pour les collections operators sont évalués de droite à gauche. -->

---

On peut utiliser `self` :

	[[@0,@2,@8,@10] valueForKeyPath:@"@avg.self"]
		// -> @5

--
Ou même `@self` :
<!-- Remember, the result of valueForKeyPath:@"<end_of_keypath>" must be a collection of NSNumbers. -->

	[array valueForKeyPath:@"@avg.@self"]

---
layout:true
# Custom Collections Operators

---

--

<!-- Merci à Nicolas Bachschmidt -->
<!-- Le type de retour est libre -->

	- (id) _<operator>ForKeyPath:(NSString*)keyPath

**Non documenté !**

---


`@standardDeviation`
	
	- (NSNumber*) _standardDeviationForKeyPath:(NSString*)keyPath

&nbsp;

	[@[@0, @5, @5, @5, @5] valueForKeyPath:@"@standardDeviation.self"]
		// -> @2
	
<!-- Retourne un NSNumber -->

---

`@differential`
	
	- (NSArray*) _differentialForKeyPath:(NSString*)keyPath

&nbsp;
	
	[@[@0, @1, @3, @0] valueForKeyPath:@"@differential.self"]
		// -> @[@1, @2, @(-3)]

<!-- Retourne un array avec un item de moins -->

---
layout:true
# (distinct)UnionOfObjects

---

--

`@unionOfObjects` ne sert à rien !

	id pencils = @[@{@"color": @"blue"},
	               @{@"color": @"red"},
	               @{@"color": @"blue"},
	               @{@"color": @"green"}];

	[pencils valueForKeyPath:@"@unionOfObjects.color"]
		// -> @[@"blue", @"red", @"blue", @"green"]

---

`@distinctUnionOfObjects` élimine les doublons :

	id pencils = @[@{@"color": @"blue"},
	               @{@"color": @"red"},
	               @{@"color": @"blue"},
	               @{@"color": @"green"}];

	[pencils valueForKeyPath:@"@distinctUnionOfObjects.color"]
		// -> @[@"blue", @"red", @"green"]
	
---
layout:true
# (distinct)UnionOfArrays/Sets

Utilisent une **collection de collections**.


---

--

`@unionOfArrays` :

	id pencils = @[@{@"color": @"blue"},
	               @{@"color": @"red"},
	               @{@"color": @"blue"}];
	id markers = @[@{@"color": @"purple"},
	               @{@"color": @"blue"},
	               @{@"color": @"green"}];
				   
	@[pencils, markers] valueForKeyPath:@"@unionOfArrays.color"]
		// ->  @[@"blue", @"red", @"blue", @"purple", @"blue", @"green"]

---

`@distinctUnionOfArrays` élimine les doublons :

	id pencils = @[@{@"color": @"blue"},
	               @{@"color": @"red"},
	               @{@"color": @"blue"}];
	id markers = @[@{@"color": @"purple"},
	               @{@"color": @"blue"},
	               @{@"color": @"green"}];
				   
	@[pencils, markers] valueForKeyPath:@"@unionOfArrays.color"]
		// ->  @[@"green", @"red", @"blue", @"purple"]
		
<!-- Et au passage, on perd l'ordre. @distinctUnionOfSets fonctionne de la même façon, et NSOrderedSet ne supporte pas ces opérateurs. -->

---
layout:true
# Le cas des valeurs nulles

---

--

> ***Important:*** *This operator raises an exception if any of the leaf objects is nil*

--

> *"This class is not key value coding-compliant for the key "key"*

--

	id objects = @[@{@"color": @"blue"},
	               @{@"color": @"red"},
	               @{@"color": @"green"},
	               @"notacolor"];
				   
	[objects valueForKeyPath:@"@unionOfObjects.color"];
	// NSUnknownKeyException : "This class is not key value coding-compliant for the key color"

---
**`@unionOfPresentObjects`**

Similaire à @unionOfObjects, mais ignore 

* les objets incompatibles,
* les valeurs nil,
* les NSNull.

--


	- (id) _unionOfPresentObjectsForKeyPath:(NSString*)keyPath
	{
	    NSMutableArray * values = [NSMutableArray new];
	    for (id obj in self) {
	        @try {
	            id value = [obj valueForKeyPath:keyPath];
	            if(value && value!=[NSNull null])
	                [values addObject:value];
	        }
	        @catch (NSException *exception) {
	        }
	    }
	    return [NSArray arrayWithArray:values];
	}

---

@unionOfPresentObjects

	id objects = @[@{@"color": @"blue"},
	               @{@"color": @"red"},
	               @{@"color": @"green"},
	               @"notacolor"];
	
	[objects valueForKeyPath:@"@unionOfPresentObjects.color"]
		// -> @[@"blue",@"red",@"green"]


---
layout:true
# Paramètres spécifiques

---

La partie de droite du keyPath peut servir à autre chose : 

--

**`@convertDistanceFromTo`**

	[arrayOfMiles valueForKeyPath:@"@convertDistanceFromTo.miles.KM"]

--

**`@filterWithRegexp`**

	[arrayOfMiles valueForKeyPath:@"@filterWithRegexp.[Mm]ozilla"]
	
	

---
layout:false
# Liens

* [Apple docs](http://developer.apple.com/library/ios/#documentation/cocoa/conceptual/KeyValueCoding/Articles/CollectionOperators.html)
* [NSHipster](http://nshipster.com/kvc-collection-operators/)

</textarea><div id="slideshow"></div></body></html>
